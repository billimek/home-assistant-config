################################################################################
### Automations related to setting the Blue Iris profile for various states
################################################################################

################################################################################
## Profile Changes
################################################################################
- id: set_bi_profile_when_selection_changes
  alias: BI - set profile when input select changes
  initial_state: on
  trigger:
    platform: state
    entity_id: input_select.set_biprofile
  action:
    service: shell_command.set_bi_profile

- id: notify_when_bi_profile_unknown
  alias: BI - notify if profile is 'unknown'
  initial_state: on
  trigger:
    platform: state
    entity_id: sensor.blue_iris_profile
    to: 'unknown'
  action:
    service: notify.slack
    data:
      message: "BI profile switched to 'unknown'"


# TODO: trigger an alert for the gasrage camera when a garage door opens and no one is home

#### Set BI profile to "alert" if a door or garage door opens while we are not home
# - alias: 'BlueIris - Set BI profile to alert if doors open while we are not home'
#   initial_state: on
#   trigger:
#     - platform: state
#       entity_id: group.doors_windows
#       to: open
#   condition:
#     condition: state
#     entity_id: group.presence
#     state: 'not_home'
#   action:
#     - service: input_select.select_option
#       data_template:
#         entity_id: input_select.set_biprofile
#         option: 'alert'


################################################################################
## Set BI profile when home to 'alert_night' at 10pm
################################################################################
- id: set_bi_profile_alert_night_10pm
  alias: BI - alert_night at 10pm when home
  initial_state: on
  trigger:
    - platform: time
      at: '22:00'
  condition:
    condition: state
    entity_id: sensor.anyone_home
    state: 'home'
  action:
    - service: input_select.select_option
      data_template:
        entity_id: input_select.set_biprofile
        option: 'alert_night'


################################################################################
## Windy / Not Windy automations
################################################################################
- id: set_bi_profile_alert_day_windy_when_not_home_and_windy
  alias: BI - alert_day_windy when not home and windy
  initial_state: on
  trigger:
    - platform: numeric_state
      entity_id: sensor.weather_wind_speed
      above: 5.0
  condition:
    condition: and
    conditions:
      - condition: sun
        after: 'sunrise'
        after_offset: "00:30:00"
      - condition: sun
        before: 'sunset'
        before_offset: "-00:30:00"
      - condition: state
        entity_id: sensor.anyone_home
        state: 'not_home'
      - condition: state
        entity_id: sensor.blue_iris_profile
        state: 'alert_day'
  action:
    - service: input_select.select_option
      data_template:
        entity_id: input_select.set_biprofile
        option: 'alert_day_windy'

- id: set_bi_profile_alert_day_when_not_home_and_not_windy
  alias: BI - alert_day when not home and not windy
  initial_state: on
  trigger:
    - platform: numeric_state
      entity_id: sensor.weather_wind_speed
      below: 5.0
  condition:
    condition: and
    conditions:
      - condition: sun
        after: 'sunrise'
        after_offset: "00:30:00"
      - condition: sun
        before: 'sunset'
        before_offset: "-00:30:00"
      - condition: state
        entity_id: sensor.anyone_home
        state: 'not_home'
      - condition: state
        entity_id: sensor.blue_iris_profile
        state: 'alert_day_windy'
  action:
    - service: input_select.select_option
      data_template:
        entity_id: input_select.set_biprofile
        option: 'alert_day'

- id: set_bi_profile_day_windy_when_home_and_windy
  alias: BI - day_windy when home and windy
  initial_state: on
  trigger:
    - platform: numeric_state
      entity_id: sensor.weather_wind_speed
      above: 5.0
  condition:
    condition: and
    conditions:
      - condition: sun
        after: 'sunrise'
        after_offset: "00:30:00"
      - condition: sun
        before: 'sunset'
        before_offset: "-00:30:00"
      - condition: state
        entity_id: sensor.anyone_home
        state: 'home'
      - condition: state
        entity_id: sensor.blue_iris_profile
        state: 'day'
  action:
    - service: input_select.select_option
      data_template:
        entity_id: input_select.set_biprofile
        option: 'day_windy'

- id: set_bi_profile_day_when_home_and_not_windy
  alias: BI - day when home and not windy
  initial_state: on
  trigger:
    - platform: numeric_state
      entity_id: sensor.weather_wind_speed
      below: 5.0
  condition:
    condition: and
    conditions:
      - condition: sun
        after: 'sunrise'
        after_offset: "00:30:00"
      - condition: sun
        before: 'sunset'
        before_offset: "-00:30:00"
      - condition: state
        entity_id: sensor.anyone_home
        state: 'home'
      - condition: state
        entity_id: sensor.blue_iris_profile
        state: 'day_windy'
  action:
    - service: input_select.select_option
      data_template:
        entity_id: input_select.set_biprofile
        option: 'day'
